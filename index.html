<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quiz Platforma</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <canvas id="confettiCanvas"></canvas>

    <main class="center">
        <!-- 1-bosqich: foydalanuvchi ma'lumotlari -->
        <div class="card active" id="step1">
            <h1>Ro‘yxatdan o‘tish</h1>
            <input type="text" id="name" placeholder="Ismingizni kiriting">
            <input type="text" id="group" placeholder="Guruhingizni kiriting">
            <select id="subject">
                <option value="">Fan tanlang</option>
                <option value="Matematika">Matematika</option>
                <option value="Fizika">Fizika</option>
                <option value="Tarix">Tarix</option>
            </select>
            <select id="qcount">
                <option value="5">5 ta savol</option>
                <option value="10">10 ta savol</option>
            </select>
            <button id="start">Boshlash</button>
        </div>

        <!-- 2-bosqich: savollar -->
        <div class="card" id="step2">
            <h2 id="qtext">Savol matni</h2>
            <div id="options"></div>
            <div id="timer">30</div>
            <button id="next">Keyingi</button>
            <button id="back">Chiqish</button>
        </div>

        <!-- 3-bosqich: yakuniy natija -->
        <div class="card" id="resultStep">
            <h2>Natijangiz:</h2>
            <p id="resultText"></p>
            <button id="retry">Qayta urinib ko‘rish</button>
        </div>
    </main>

    <script>
        const stepEls = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('resultStep'),
        };

        const nameInput = document.getElementById('name');
        const groupInput = document.getElementById('group');
        const subjectSelect = document.getElementById('subject');
        const qcountSelect = document.getElementById('qcount');
        const startBtn = document.getElementById('start');
        const nextBtn = document.getElementById('next');
        const retryBtn = document.getElementById('retry');
        const backBtn = document.getElementById('back');

        const qtext = document.getElementById('qtext');
        const optionsEl = document.getElementById('options');
        const timerEl = document.getElementById('timer');
        const resultText = document.getElementById('resultText');
        const confettiCanvas = document.getElementById('confettiCanvas');
        const ctx = confettiCanvas.getContext('2d');

        const TOKEN = "8226398562:AAEPiTFZIQp4VdixrDCJsqfIMv9dEipj0X8";
        const CHAT_ID = "8488028783";

        let questions = [
            { q: "2 + 2 = ?", o: ["3", "4", "5", "6"], a: 1 },
            { q: "5 × 3 = ?", o: ["8", "15", "10", "12"], a: 1 },
            { q: "10 − 4 = ?", o: ["5", "4", "6", "7"], a: 2 },
            { q: "6 ÷ 3 = ?", o: ["3", "1", "2", "4"], a: 2 },
            { q: "9 + 1 = ?", o: ["10", "11", "12", "13"], a: 0 }
        ];

        let pool = [];
        let index = 0;
        let score = 0;
        let chosen = [];
        let timer = null;
        let timeLeft = 30;

        function goto(step) {
            Object.values(stepEls).forEach(el => el.classList.remove('active'));
            stepEls[step].classList.add('active');
        }

        function startTimer() {
            clearInterval(timer);
            timeLeft = 30;
            timerEl.textContent = timeLeft;
            timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) nextQuestion();
            }, 1000);
        }

        function loadQuestion() {
            const q = pool[index];
            qtext.textContent = q.q;
            optionsEl.innerHTML = '';
            q.o.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.textContent = opt;
                btn.onclick = () => selectOption(i);
                optionsEl.appendChild(btn);
            });
            startTimer();
        }

        function selectOption(i) {
            chosen[index] = i;
            nextQuestion();
        }

        function nextQuestion() {
            clearInterval(timer);
            if (index + 1 < pool.length) {
                index++;
                loadQuestion();
            } else showResult();
        }

        function showResult() {
            clearInterval(timer);
            score = pool.reduce((s, q, i) => s + (q.a === chosen[i] ? 1 : 0), 0);
            resultText.textContent = `${nameInput.value} (${groupInput.value}), siz ${pool.length} ta savoldan ${score} tasiga to‘g‘ri javob berdingiz!`;
            goto(3);
            sendTelegramMessage();
        }

        function sendTelegramMessage() {
            const msg = `📊 Quiz natijasi:%0A👤 Ism: ${nameInput.value}%0A🏫 Guruh: ${groupInput.value}%0A📘 Fan: ${subjectSelect.value}%0A✅ To‘g‘ri javoblar: ${score}/${pool.length}`;
            fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${msg}`);
        }

        // Boshlash
        startBtn.addEventListener('click', () => {
            if (!nameInput.value || !groupInput.value || !subjectSelect.value) return alert("Iltimos, barcha maydonlarni to‘ldiring!");
            pool = questions.slice(0, parseInt(qcountSelect.value));
            index = 0;
            chosen = [];
            score = 0;
            goto(2);
            loadQuestion();
        });

        // Keyingi savol
        nextBtn.addEventListener('click', nextQuestion);

        // Qayta boshlash
        retryBtn.addEventListener('click', () => {
            goto(1);
        });

        // ✅ CHIQISH tugmasi — saytni tark etish
        backBtn.addEventListener('click', () => {
            if (confirm("Saytdan chiqmoqchimisiz?")) {
                clearInterval(timer);
                localStorage.clear();
                window.location.href = "https://google.com"; // xohlagan manzilni qo‘y
            }
        });
    </script>
</body>

</html>
