<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quiz Mukammal</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <canvas id="confettiCanvas"></canvas>

    <main>
        <div class="quiz-container" role="main" aria-labelledby="title">
            <h1 id="title">ğŸ“š Quiz</h1>

            <!-- STEP 1: Ro'yhatdan o'tish -->
            <section id="step1" class="step active">
                <h3>Ro'yhatdan o'ting</h3>
                <input id="name" type="text" placeholder="Ism familiya" /><br>
                <input id="group" type="text" placeholder="Guruh" />
                <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
                    <button id="toStep2">Keyingi â¡ï¸</button>
                </div>
            </section>

            <!-- STEP 2: Fan va savol soni -->
            <section id="step2" class="step hidden">
                <h3>Fan va savol soni</h3>
                <select id="subject">
                    <option value="informatika">ğŸ“˜ Informatika</option>
                    <option value="matematika">ğŸ“— Matematika</option>
                    <option value="fizika">ğŸ“™ Fizika</option>
                    <option value="tarix">ğŸ“• Tarix</option>
                </select>
                <select id="qcount" style="margin-top:8px">
                    <option value="5">5 savol</option>
                    <option value="10" selected>10 savol</option>
                    <option value="20">20 savol</option>
                </select>
                <div style="display:flex;justify-content:center;gap:8px;margin-top:10px">
                    <button class="ghost" id="back1">â—€ï¸ Orqaga</button>
                    <button id="startQuiz">Boshlash</button>
                </div>
            </section>

            <!-- STEP 3: Quiz -->
            <section id="step3" class="step hidden">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="small">Fan: <strong id="metaSubject"></strong></div>
                        <div class="small">Ism: <strong id="metaName"></strong> Â· Guruh: <strong id="metaGroup"></strong></div>
                    </div>
                    <div>
                        <div id="timer">â° 00:00</div>
                    </div>
                </div>

                <div id="progressBar">
                    <div id="progress"></div>
                </div>

                <main id="quiz" style="min-height:160px;margin-top:12px"></main>

                <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                    <button class="ghost" id="prevBtn">â—€ï¸ Orqaga</button>
                    <button id="nextBtn">â¡ï¸ Keyingi</button>
                    <button id="submitBtn" class="hidden">âœ… Tugatish</button>
                </div>
                <div class="small" style="margin-top:8px">Savollar: <span id="totalCount">0</span></div>
            </section>

            <!-- STEP 4: Natija -->
            <section id="resultStep" class="step hidden">
                <div class="result-box">
                    <div style="text-align:center">
                        <div id="resultEmoji" style="font-size:48px">ğŸ‰</div>
                        <h2 id="resultTitle"></h2>
                        <p id="resultText"></p>
                        <p id="resultDetails" class="meta"></p>

                        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                            <button id="sendTelegramResult">ğŸ”” Telegramga yuborish</button>
                            <button id="retry">ğŸ” Yana boshlash</button>
                            <button id="back">Chiqish</button>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Reklama modal -->
    <div id="adModal" class="hidden">
        <div class="adBox">
            <h3>Reklama</h3>
            <p>Reklamani kuting...</p>
            <button id="closeAdBtn">X</button>
        </div>
    </div>

    <script>
        /* ======================
        Reklama Modal JS
        ====================== */
        const adModal = document.getElementById('adModal');
        const closeAdBtn = document.getElementById('closeAdBtn');
        function showAd(duration = 5000) {
            adModal.classList.remove('hidden');
            closeAdBtn.style.display = 'none';
            setTimeout(() => { closeAdBtn.style.display = 'inline-block'; }, duration);
        }
        window.addEventListener('load', ()=>{
            const today = new Date().toISOString().slice(0,10);
            if(localStorage.getItem('adSeenToday') !== today){
                showAd(5000);
                closeAdBtn.onclick = ()=>{
                    localStorage.setItem('adSeenToday', today);
                    adModal.classList.add('hidden');
                }
            }
        });

        /* ======================
        Quiz JS
        ====================== */
        const stepEls = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('step3'),
            4: document.getElementById('resultStep')
        };
        const nameInput = document.getElementById('name');
        const groupInput = document.getElementById('group');
        const subjectSelect = document.getElementById('subject');
        const qcountSelect = document.getElementById('qcount');
        const toStep2Btn = document.getElementById('toStep2');
        const back1Btn = document.getElementById('back1');
        const startQuizBtn = document.getElementById('startQuiz');

        const quizEl = document.getElementById('quiz');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const timerEl = document.getElementById('timer');
        const totalCountEl = document.getElementById('totalCount');
        const metaSubject = document.getElementById('metaSubject');
        const metaName = document.getElementById('metaName');

        const resultEmoji = document.getElementById('resultEmoji');
        const resultTitle = document.getElementById('resultTitle');
        const resultText = document.getElementById('resultText');
        const resultDetails = document.getElementById('resultDetails');

        let userName='', userGroup='', subject='', qcount=10;
        let pool=[], index=0, score=0, chosen=[], timer=null, timeLeft=0;
        let wrongQuestions = [];

        const BANK = {
            informatika: [
                {q:"Axborot deb nimaga aytiladi?", a:["Atrofdagi voqea-hodisalar haqidagi ma'lumotlarga","Faqat matnli ma'lumotlarga","Faqat sonli qiymatlarga"], correct:0},
                {q:"1 bayt nechta bitdan iborat?", a:["16 bit","8 bit","4 bit"], correct:1},
                {q:"Kompyuterning asosiy xotirasi qaysi?", a:["ROM","HDD","RAM"], correct:2}
            ],
            matematika:[
                {q:"2 + 2 = ?", a:["3","4","22"], correct:1},
                {q:"5 * 6 = ?", a:["30","11","56"], correct:0}
            ]
        };

        function goto(step){
            Object.values(stepEls).forEach(el=>el.classList.remove('active'));
            stepEls[step].classList.add('active');
        }

        toStep2Btn.addEventListener('click', ()=>{
            userName = nameInput.value.trim();
            userGroup = groupInput.value.trim();
            if(!userName || !userGroup) return alert('Iltimos, ism va guruhni kiriting.');
            metaName.textContent = userName;
            goto(2);
        });

        back1Btn.addEventListener('click', ()=>goto(1));

        startQuizBtn.addEventListener('click', ()=>{
            subject = subjectSelect.value;
            qcount = parseInt(qcountSelect.value,10)||10;
            pool = (BANK[subject]||[]).slice(0,qcount);
            index=0; score=0; chosen=new Array(pool.length).fill(null); wrongQuestions=[];
            totalCountEl.textContent = pool.length;
            metaSubject.textContent = subject.charAt(0).toUpperCase()+subject.slice(1);
            goto(3);
            renderQuestion();
        });

        function renderQuestion(){
            const item = pool[index];
            quizEl.innerHTML='';
            const qdiv = document.createElement('div');
            qdiv.innerHTML = `<p><strong>${index+1}.</strong> ${item.q}</p>`;
            quizEl.appendChild(qdiv);
            item.a.forEach((opt,i)=>{
                const lbl = document.createElement('label');
                lbl.innerHTML = `<input type="radio" name="opt" value="${i}" ${chosen[index]===i?'checked':''}> ${opt}`;
                lbl.addEventListener('click',()=>selectOption(i));
                quizEl.appendChild(lbl);
            });
            prevBtn.classList.toggle('hidden',index===0);
            nextBtn.classList.toggle('hidden',index>=pool.length-1);
            submitBtn.classList.toggle('hidden',index<pool.length-1);
        }

        function selectOption(i){
            chosen[index]=i;
            if(i!==pool[index].correct) wrongQuestions.push(index+1);
            if(i===pool[index].correct) score+=1;
        }

        nextBtn.addEventListener('click',()=>{
            if(chosen[index]===null) return alert('Iltimos javobni tanlang');
            if(index<pool.length-1){index++; renderQuestion();}
        });
        prevBtn.addEventListener('click',()=>{
            if(index>0){index--; renderQuestion();}
        });
        submitBtn.addEventListener('click', finishTest);

        function finishTest(){
            clearInterval(timer);
            const percent = ((score/pool.length)*100).toFixed(1);
            resultEmoji.textContent = percent>=60?'ğŸ‰':'ğŸ™‚';
            resultTitle.textContent = percent>=60?'Tabriklaymiz!':'Yaxshiroq tayyorgarlik kerak';
            resultText.textContent = `Siz ${subject} fanidan ${score}/${pool.length} (${percent}%) natija oldingiz.`;
            if(wrongQuestions.length>0) resultText.textContent += ` Xato savollar: ${wrongQuestions.join(', ')}`;
            goto(4);
        }

        const retryBtn = document.getElementById('retry');
        retryBtn.addEventListener('click',()=>{
            nameInput.value=''; groupInput.value=''; 
            goto(1);
        });

        const backBtn = document.getElementById('back');
        backBtn.addEventListener('click',()=>goto(1));

        goto(1);
    </script>
</body>
</html>
