<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quiz</title>
    <link rel="stylesheet" href="./stayle.css">

</head>

<body>
    <canvas id="confettiCanvas"></canvas>

    <main>
        <div class="quiz-container" role="main" aria-labelledby="title">
            <h1 id="title">üìö Quiz</h1>

            <!-- STEP 1 -->
            <section id="step1" class="step active" aria-hidden="false">
                <h3>Ro'yhatdan o'ting</h3>
                <input id="name" type="text" placeholder="Ism familiya" /><br>
                <input id="group" type="text" placeholder="Guruh" />
                <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
                    <button id="toStep2">Keyingi ‚û°Ô∏è</button>
                </div>
            </section>

            <!-- STEP 2 -->
            <section id="step2" class="step" aria-hidden="true">
                <h3>Fan va savol soni</h3>
                <select id="subject">
                    <option value="informatika">üìò Informatika</option>
                    <option value="matematika">üìó Matematika</option>
                    <option value="fizika">üìô Fizika</option>
                    <option value="tarix">üìï Tarix</option>
                </select>
                <select id="qcount" style="margin-top:8px">
                    <option value="5">5 savol</option>
                    <option value="10" selected>10 savol</option>
                    <option value="20">20 savol</option>
                </select>

                <div style="display:flex;justify-content:center;gap:8px;margin-top:10px">
                    <button class="ghost" id="back1">‚óÄÔ∏è Orqaga</button>
                    <button id="startQuiz">Boshlash</button>
                </div>
                <div class="small"></div>
            </section>

            <!-- STEP 3 (QUIZ) -->
            <section id="step3" class="step" aria-hidden="true">
                <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
                    <div style="text-align:left">
                        <div class="small">Fan: <strong id="metaSubject"></strong></div>
                        <div class="small">Ism: <strong id="metaName"></strong> ¬∑ Guruh: <strong
                                id="metaGroup"></strong></div>
                    </div>
                    <div style="text-align:right">
                        <div id="timer">‚è∞ 00:00</div>
                    </div>
                </div>

                <div id="progressBar">
                    <div id="progress"></div>
                </div>

                <main id="quiz" style="min-height:160px;margin-top:12px"></main>

                <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                    <button class="ghost" id="prevBtn">‚óÄÔ∏è Orqaga</button>
                    <button id="nextBtn">‚û°Ô∏è Keyingi</button>
                    <button id="submitBtn" class="hidden">‚úÖ Tugatish</button>
                </div>
                <div class="small" style="margin-top:8px">Savollar: <span id="totalCount">0</span></div>
            </section>

            <!-- STEP 4 (RESULT) -->
            <section id="resultStep" class="step" aria-hidden="true">
                <div class="result-box">
                    <div style="text-align:center">
                        <div id="resultEmoji" style="font-size:48px">üéâ</div>
                        <h2 id="resultTitle"></h2>
                        <p id="resultText"></p>
                        <p id="resultDetails" class="meta"></p>

                        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                            <button id="sendTelegramResult">üîî Telegramga yuborish</button>
                            <button id="retry">üîÅ Yana boshlash</button>
                            <button id="back">chiqish</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- history + export -->
            <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                <button class="ghost" id="showHistory">üìú Oldingi natijalar</button>
                <button class="ghost" id="clearHistory">üóë Tozalash</button>
                <button class="ghost" id="exportCSV">üì§ CSV eksport</button>
            </div>

            <!-- history modal inline -->
            <div id="historyPanel" class="hidden" style="margin-top:12px;text-align:left">
                <h3>Oldingi natijalar</h3>
                <div class="history-list" id="historyList"></div>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                    <button id="closeHistory" class="ghost">Yopish</button>
                </div>
            </div>

        </div>
    </main>

    <script>
        /* ======================
          BANK ‚Äî savollar (kengaytirish mumkin)
          ====================== */
        const BANK = {
            informatika: [
                { q: "Axborot deb nimaga aytiladi?", a: ["Atrofdagi voqea-hodisalar haqidagi ma'lumotlarga", "Faqat matnli ma'lumotlarga", "Faqat sonli qiymatlarga"], correct: 0 },
                { q: "1 bayt nechta bitdan iborat?", a: ["16 bit", "8 bit", "4 bit"], correct: 1 },
                { q: "Kompyuterning asosiy xotirasi qaysi?", a: ["ROM", "HDD", "RAM"], correct: 2 },
                { q: "Protsessor nima vazifani bajaradi?", a: ["Ma'lumotlarni qayta ishlaydi", "Axborotni saqlaydi", "Rasm chizadi"], correct: 0 },
                { q: "Dastur bu ‚Äî ...?", a: ["Kompyuter o'yini", "Kompyuter bajaradigan buyruqlar ketma-ketligi", "Tizim fayli"], correct: 1 },
                { q: "Fayl kengaytmasi .exe nimani bildiradi?", a: ["Ishga tushuvchi fayl", "Rasm fayli", "Matnli fayl"], correct: 0 },
                { q: "Operatsion tizimning asosiy vazifasi nima?", a: ["Ma'lumotlarni bosib chiqarish", "Foydalanuvchi bilan kompyuter o'rtasida vositachilik qilish", "Rasm chizish"], correct: 1 },
                { q: "Qattiq disk (HDD) nima uchun ishlatiladi?", a: ["Axborotni saqlash uchun", "Tarmoqni sozlash uchun", "Monitorni boshqarish uchun"], correct: 0 },
                { q: "1 kilobayt nechta baytga teng?", a: ["2048", "1000", "1024"], correct: 2 },
                { q: "Tizim fayllari odatda qayerda joylashadi?", a: ["Dokumentlar papkasida", "Windows papkasida", "Rasm papkasida"], correct: 1 }
            ],
            matematika: [
                { q: "2 + 2 = ?", a: ["3", "4", "22"], correct: 1 },
                { q: "5 * 6 = ?", a: ["30", "11", "56"], correct: 0 },
                { q: "Kvadratning perimetri qanday hisoblanadi?", a: ["4 * tomoni", "2 * pi * r", "a^2"], correct: 0 },
                { q: "Pifagor teoremasi qaysi qator bilan bog'liq?", a: ["To'g'ri burchakli uchburchak", "Doira", "Kvadrat"], correct: 0 },
                { q: "0 ning istalgan son bilan ko'paytmasi ?", a: ["0", "1", "Noma'lum"], correct: 0 },
                { q: "1/2 + 1/3 = ?", a: ["5/6", "2/5", "3/6"], correct: 0 },
                { q: "10^2 = ?", a: ["100", "10", "20"], correct: 0 },
                { q: "Aralash son 1 1/2 = ?", a: ["3/2", "1.5", "Ikkala to'g'ri"], correct: 2 },
                { q: "Satrda 'x' ni toping: 2x=10", a: ["x=5", "x=8", "x=2"], correct: 0 },
                { q: "To'g'ri burchakli uchburchakda gipotenuza qanday topiladi?", a: ["a^2 + b^2 = c^2", "a+b=c", "a*b=c"], correct: 0 }
            ],
            fizika: [
                { q: "Tezlik birligi nima?", a: ["m/s", "kg", "s"], correct: 0 },
                { q: "Massaning birligi nima?", a: ["kg", "m/s", "N"], correct: 0 },
                { q: "Erkin tushish tezlanishi taxminan?", a: ["9.8 m/s^2", "3 m/s^2", "0.98 m/s^2"], correct: 0 },
                { q: "Ovoz qancha tezlik bilan tarqaladi (havo, taxminan)?", a: ["~340 m/s", "~3 m/s", "~3400 m/s"], correct: 0 },
                { q: "Energiya birligi?", a: ["Joul (J)", "Volt (V)", "Amper (A)"], correct: 0 },
                { q: "Quvvat (power) formulasi?", a: ["P = W / t", "P = m * a", "P = V/I"], correct: 0 },
                { q: "Ohm qonuni:", a: ["V = I * R", "P = V * I", "E = mc^2"], correct: 0 },
                { q: "Elektr toki birligi?", a: ["A (amper)", "V (volt)", "Ohm"], correct: 0 },
                { q: "Massani vaqtga bo'lganda hosil bo'ladigan narsa?", a: ["mass/time (not common)", "Noma'lum", "hech narsa"], correct: 0 },
                { q: "S√ºrt√ºnish kuchi nimaga bog'liq?", a: ["Sirt va normal kuchga", "Haroratga", "Vaqtga"], correct: 0 }
            ],
            tarix: [
                { q: "O'zbekiston mustaqillikka qachon erishdi?", a: ["1991", "1989", "2001"], correct: 0 },
                { q: "Buyuk Ipak yo'li qaysi maqsad uchun?", a: ["Savdo va madaniy almashinuv", "Urush", "Faqat sayohat"], correct: 0 },
                { q: "Qadimgi Misrda piramidalar nimaga qurilgan?", a: ["Mo'ljallangan qabriyalar", "Kasb joylari", "Shahar"], correct: 0 },
                { q: "Renessans qaysi sohada boshlandi?", a: ["San'at va ilm", "Agrar", "Texnika"], correct: 0 },
                { q: "O'rta asrlar davri qaysi asrlar oralig'ida?", a: ["5-15 asrlar", "1-3 asrlar", "17-18 asrlar"], correct: 0 },
                { q: "Birinchi jahon urushi qachon boshlandi?", a: ["1914", "1939", "1905"], correct: 0 },
                { q: "Fransuz inqilobi qachon bo ªldi?", a: ["1789", "1812", "1804"], correct: 0 },
                { q: "O ªzbekistonda qadimgi davlat tuzilmalariga misol?", a: ["Xorazm, Samanid", "AQSh", "Yaponiya"], correct: 0 },
                { q: "Tarixiy manbalar qanday bo'lishi mumkin?", a: ["Matn, arxeologiya, og'zaki", "Faqat kitoblar", "Faqat suratlar"], correct: 0 },
                { q: "Buyuk kashfiyotlar davri qaysi asrga to'g'ri keladi?", a: ["15-17 asrlar", "10-12 asrlar", "19 asr"], correct: 0 }
            ]
        };

        /* ======================
          ELEMENTS & STATE
          ====================== */
        const stepEls = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('step3'),
            4: document.getElementById('resultStep')
        };
        const nameInput = document.getElementById('name');
        const groupInput = document.getElementById('group');
        const subjectSelect = document.getElementById('subject');
        const qcountSelect = document.getElementById('qcount');
        const toStep2Btn = document.getElementById('toStep2');
        const back1Btn = document.getElementById('back1');
        const startQuizBtn = document.getElementById('startQuiz');

        const quizEl = document.getElementById('quiz');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const timerEl = document.getElementById('timer');
        const totalCountEl = document.getElementById('totalCount');

        const metaSubject = document.getElementById('metaSubject');
        const metaName = document.getElementById('metaName');

        const resultEmoji = document.getElementById('resultEmoji');
        const resultTitle = document.getElementById('resultTitle');
        const resultText = document.getElementById('resultText');
        const resultDetails = document.getElementById('resultDetails');
        const sendTelegramResultBtn = document.getElementById('sendTelegramResult');
        const retryBtn = document.getElementById('retry');

        const showHistoryBtn = document.getElementById('showHistory');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const closeHistoryBtn = document.getElementById('closeHistory');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const exportCSVBtn = document.getElementById('exportCSV');

        const progressEl = document.getElementById('progress');

        const confettiCanvas = document.getElementById('confettiCanvas');
        const ctx = confettiCanvas.getContext?.('2d');

        /* state */
        let userName = '', userGroup = '', subject = '', qcount = 10;
        let pool = [], index = 0, score = 0, chosen = [];
        let timer = null, timeLeft = 0;
        let confettiParticles = [];

        /* ======================
          UTIL
          ====================== */
        function goto(step) {
            Object.values(stepEls).forEach(el => el.classList.remove('active'));
            const target = stepEls[step];
            if (!target) return;
            target.classList.add('active');
        }
        function fmtTime(s) { const m = Math.floor(s / 60), sec = s % 60; return `${m < 10 ? '0' + m : m}:${sec < 10 ? '0' + sec : sec}`; }
        function shuffle(a) { return a.slice().sort(() => Math.random() - 0.5); }
        function saveHistory(entry) { const h = JSON.parse(localStorage.getItem('quiz_history_v2') || '[]'); h.unshift(entry); localStorage.setItem('quiz_history_v2', JSON.stringify(h.slice(0, 200))); }
        function getHistory() { return JSON.parse(localStorage.getItem('quiz_history_v2') || '[]'); }

        /* resize confetti canvas */
        function resizeCanvas() { if (!ctx) return; confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        /* ======================
          NAV: step1 -> step2
          ====================== */
        toStep2Btn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            userGroup = groupInput.value.trim();
            if (!userName || !userGroup) { return alert('Iltimos, ism va guruhni kiriting.'); }
            metaName.textContent = userName;
            goto(2);
        });
        back1Btn?.addEventListener('click', () => goto(1));

        /* ======================
          START QUIZ (step2 -> step3)
          ====================== */
        startQuizBtn.addEventListener('click', () => {
            subject = subjectSelect.value;
            qcount = parseInt(qcountSelect.value, 10) || 10;
            const bank = BANK[subject] || [];
            pool = shuffle(bank).slice(0, Math.min(qcount, bank.length));
            index = 0; score = 0; chosen = new Array(pool.length).fill(null);
            totalCountEl.textContent = pool.length;
            metaSubject.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
            goto(3);
            startTimerAndRender();
            // notify start (optional) - comment if not needed
            // sendTelegramMessage(`üìù Test boshlandi\nIsm: ${userName}\nGuruh: ${userGroup}\nFan: ${subject}\nSavollar: ${pool.length}`);
        });

        /* ======================
          TIMER & RENDER
          ====================== */
        function startTimerAndRender() {
            timeLeft = Math.max(60, pool.length * 30); // 30s per question
            timerEl.textContent = '‚è∞ ' + fmtTime(timeLeft);
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = '‚è∞ ' + fmtTime(timeLeft);
                if (timeLeft <= 0) { clearInterval(timer); alert('‚è∞ Vaqt tugadi'); finishTest(); }
            }, 1000);
            renderQuestion();
        }

        function renderQuestion() {
            const item = pool[index];
            quizEl.innerHTML = '';
            const qdiv = document.createElement('div');
            qdiv.className = 'question';
            qdiv.innerHTML = `<p><strong>${index + 1}.</strong> ${item.q}</p>`;
            quizEl.appendChild(qdiv);

            item.a.forEach((opt, i) => {
                const lbl = document.createElement('label');
                lbl.innerHTML = `<input type="radio" name="opt" value="${i}" ${chosen[index] === i ? 'checked' : ''}> ${opt}`;
                lbl.addEventListener('click', () => selectOption(i, lbl));
                quizEl.appendChild(lbl);
            });

            progressEl.style.width = ((index / pool.length) * 100) + '%';
            prevBtn.classList.toggle('hidden', index === 0);
            nextBtn.classList.toggle('hidden', index >= pool.length - 1);
            submitBtn.classList.toggle('hidden', index < pool.length - 1);
        }

        /* ======================
          SELECT OPTION
          ====================== */
        function selectOption(optIndex, labelEl) {
            if (chosen[index] !== null) return; // prevent double
            chosen[index] = optIndex;
            const correctIdx = pool[index].correct;
            const labels = quizEl.querySelectorAll('label');
            labels.forEach((l, i) => {
                l.classList.remove('correct', 'wrong');
                const input = l.querySelector('input');
                input.disabled = true;
                if (i === correctIdx) l.classList.add('correct');
                if (i === optIndex && i !== correctIdx) l.classList.add('wrong');
            });
            if (optIndex === correctIdx) score += 1;
        }

        /* ======================
          NAV buttons inside quiz
          ====================== */
        nextBtn.addEventListener('click', () => {
            if (chosen[index] === null) return alert('Iltimos, javobni tanlang.');
            if (index < pool.length - 1) { index++; renderQuestion(); }
        });
        prevBtn.addEventListener('click', () => {
            if (index > 0) { index--; renderQuestion(); }
        });
        submitBtn.addEventListener('click', finishTest);

        /* ======================
          FINISH: show result, save, send to telegram
          ====================== */
        function finishTest() {
            clearInterval(timer);
            const percent = ((score / pool.length) * 100).toFixed(1);
            resultEmoji.textContent = percent >= 60 ? 'üéâ' : 'üôÇ';
            resultTitle.textContent = percent >= 60 ? 'Tabriklaymiz!' : "Yaxshiroq tayyorgarlik kerak";
            resultText.textContent = `Siz ${subject} fanidan ${score}/${pool.length} (${percent}%) natija oldingiz.`;
            const dt = new Date();
            const dateStr = dt.toLocaleString();
            resultDetails.textContent = `Ism: ${userName} ¬∑ Guruh: ${userGroup} ¬∑ Sana: ${dateStr}`;
            goto(4);

            // save to local history
            saveHistory({ name: userName, group: userGroup, subject, score, total: pool.length, percent, date: dateStr });

            // send to telegram automatically (replace placeholders below with your values)
            const message = `üèÅ Test yakunlandi
üë§ Ism: ${userName}
üè´ Guruh: ${userGroup}
üìò Fan: ${subject}
‚úÖ To'g'ri: ${score}/${pool.length} (${percent}%)
‚è∞ Tugatildi: ${dateStr}
`;
            // Use this line to actually send ‚Äî replace TOKEN & CHAT_ID placeholders
            sendTelegramMessage(message);
            // Start confetti on decent result
            if (percent >= 50) startConfetti();
        }
        function sendTelegramMessage(text) {
            // Place your token/chat id here
            const TOKEN = "8226398562:AAEPiTFZIQp4VdixrDCJsqfIMv9dEipj0X8";   // <-- o'zing joylashtir
            const CHAT_ID = "8488028783";   // <-- o'zing joylashtir

            if (TOKEN.includes("BOT_TOKEN") || CHAT_ID.includes("CHAT_ID")) {
                // placeholder ‚Äî token yo'q bo'lsa, faqat konsolga chiqaramiz
                console.warn("Telegram token yoki chat_id o'rnatilmagan. Xabar:", text);
                return;
            }

            fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chat_id: CHAT_ID, text })
            }).then(res => res.json()).then(data => {
                if (!data.ok) console.warn("Telegram xato:", data);
                else console.log("Natija Telegramga yuborildi.");
            }).catch(err => {
                console.error("Telegram fetch xatosi:", err);
            });
        }

        /* ======================
          Confetti (simple)
          ====================== */
        function startConfetti() {
            if (!ctx) return;
            confettiParticles = [];
            const colors = ['#ff0', '#f00', '#0f0', '#00f', '#ff8c00', '#ff1493', '#60a5fa', '#34d399'];
            for (let i = 0; i < 160; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * -confettiCanvas.height,
                    r: Math.random() * 6 + 2,
                    c: colors[Math.floor(Math.random() * colors.length)],
                    s: Math.random() * 3 + 1,
                    rot: Math.random() * 360
                });
            }
            requestAnimationFrame(confettiLoop);
            setTimeout(() => confettiParticles = [], 6000);
        }
        function confettiLoop() {
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.c;
                ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 1.6);
                ctx.restore();
                p.y += p.s;
                p.rot += p.s * 2;
                if (p.y > confettiCanvas.height + 20) {
                    p.y = -10 - Math.random() * 100;
                    p.x = Math.random() * confettiCanvas.width;
                }
            });
            if (confettiParticles.length) requestAnimationFrame(confettiLoop);
        }

        /* ======================
          History / Export
          ====================== */
        showHistoryBtn.addEventListener('click', () => {
            populateHistory();
            historyPanel.classList.remove('hidden');
        });
        closeHistoryBtn.addEventListener('click', () => historyPanel.classList.add('hidden'));
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Haqiqatan ham tarixni tozalaysizmi?')) { localStorage.removeItem('quiz_history_v2'); populateHistory(); }
        });
        exportCSVBtn.addEventListener('click', () => {
            const arr = getHistory();
            if (!arr.length) return alert('Hech qanday tarix topilmadi');
            const csv = ['Ism,Guruh,Fan,Score,Total,Percent,Sana', ...arr.map(r => `${r.name},${r.group},${r.subject},${r.score},${r.total},${r.percent},${r.date}`)].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'quiz_history.csv'; a.click(); URL.revokeObjectURL(url);
        });

        function populateHistory() {
            const arr = getHistory();
            historyList.innerHTML = '';
            if (!arr.length) { historyList.innerHTML = '<div class="small">Hech qanday natija topilmadi</div>'; return; }
            arr.forEach(it => {
                const el = document.createElement('div'); el.className = 'history-item';
                el.innerHTML = `<div><strong>${it.name}</strong><div class="small">${it.group} ¬∑ ${it.subject}</div></div>
                    <div style="text-align:right"><div><strong>${it.score}/${it.total}</strong></div><div class="small">${it.percent}% ¬∑ ${it.date}</div></div>`;
                historyList.appendChild(el);
            });

        }
        const backBtn = document.getElementById('back');
        backBtn.addEventListener('click', () => {
            if (confirm("Chiqmoqchimisiz?")) {
                // barcha ma'lumotlarni tozalash va bosh sahifaga qaytish
                clearInterval(timer);
                pool = [];
                index = 0;
                score = 0;
                chosen = [];
                nameInput.value = '';
                groupInput.value = '';
                subjectSelect.selectedIndex = 0;
                qcountSelect.selectedIndex = 1;
                goto(1);
            }
        });


        /* ======================
          Manual "send result" & retry
          ====================== */
        sendTelegramResultBtn.addEventListener('click', () => {
            // Recreate same message as finish
            const last = getHistory()[0];
            if (!last) return alert('Hech nima topilmadi. Avval testni tugating.');
            const message = `üîî Natija:
üë§ Ism: ${last.name}
üè´ Guruh: ${last.group}
üìò Fan: ${last.subject}
‚úÖ Natija: ${last.score}/${last.total} (${last.percent}%)
‚è∞ Sana: ${last.date}`;
            sendTelegramMessage(message);
            alert('Natija Telegramga yuborildi');
        });

        retryBtn.addEventListener('click', () => {
            // reset inputs and go to step1
            pool = []; index = 0; score = 0; chosen = [];
            nameInput.value = ''; groupInput.value = '';
            goto(1);
        });

        /* ======================
          Init
          ====================== */
        goto(1);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { historyPanel.classList.add('hidden'); } });
    </script>
</body>

</html>